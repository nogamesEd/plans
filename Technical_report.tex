\documentclass[onecolumn]{IEEEtran}

% Basic required LaTeX packages
\usepackage[english]{babel} 
\usepackage[utf8]{inputenc} 
\usepackage[T1]{fontenc}
\usepackage{charter}

% Packages which allow format customisation
\usepackage{titling}
\usepackage{cite}
\usepackage{caption}
\usepackage{textcomp}
\usepackage{xcolor}
\usepackage{etoolbox} 
\patchcmd{\section}{\centering}{}{}{} % uses the etoolbox package to left align section headings

% Packages which help display things like maths and images correctly
\usepackage{amsmath,amssymb,amsfonts}
\usepackage{algorithm}
%\usepackage{algorithmic}
\usepackage{algcompatible}
\usepackage{graphicx}
\usepackage{hyperref}
\usepackage{multirow}
\usepackage[export]{adjustbox}
\usepackage{textcomp}
\usepackage{pifont}
\usepackage{longtable}

% All your code should be in between the \begin{document} and \end{document} tags otherwise your compiler willl throw an error
\begin{document}

%\tableofcontents % optional


\title{Group 12 Technical Report}
%\date{} % Leave blank to omit date. Comment out to include today's date or you can add a specific date
\maketitle

\section{Introduction}
Checkmate is a personal AI chess playing assistant, designed to allow individuals to play chess without having to interact with a computer. Playing chess online opens up a wide range of options for chess players, including difficulty levels, the ability to play against an AI, and the ability to choose different opening strategies for the opposing AI to take. However, playing on a board has an appeal that playing online will never match, so Checkmate combines the best of both options: The ability to play against an AI with varying difficulty levels on a board. Additionally, The negative effects of blue light (also known as digital light) on eyesight [1], sleep quality, and mood [2] has been documented in multiple studies, so Checkmate will encourage chess players to avoid more screen time than necessary. \par
Checkmate's target market is chess clubs, both in and outside of schools. Screen time is shown to significantly effect young people, by disrupting their circadian rhythms, leading to significant mood changes, and even depression and anxiety [3]. During Checkmate's future development it will be possible to choose an opening style or game style, which would be useful for educational purposes to introduce chess students to a variety of styles of play and how to defend against them. Other chess-playing robots exist on the market, but the ones that do exist are all built in-board, whereas Checkmate can play on a variety of boards. Many players have preferred boards for aesthetic or nostalgic reasons, which contributes to the desire to play chess offline, and Checkmate accommodates this desire. \par
This report provides details into Checkmate's technical structure and software. The hardware section will provide details on how Checkmate was constructed and the reasons behind each decision, and the software section will provide details into the structure of the codebase and summaries of the key algorithms. Quantitative data from thorough testing is provided after the section on software, and then a short reflection on both Checkmate's presentation to a panel of professionals, and the difficulties and achievements over the 11 week process of creating Checkmate. \par
\section{Hardware}
Numerous possible ideas for how Checkmate could be constructed were discussed, but in the end a half-gantry crane model was adopted. Two long struts lie on either side of a chessboard, to allow the gripper to move backwards and forwards along the chessboard. Two uprights protrude from moving bases, one on each strut on the floor, with a bar connecting the two uprights. A chain taut between the two uprights hangs above the bar connecting the two uprights, and then gripper hangs from this chain. The chain can move left and right, allowing the gripper to move left and right across the board. The gripper is suspended between two thin strips on either side of the bar connecting the uprights, and these thin strips can be moved up and down, thereby moving the gripper up and down to grip and move pieces without knocking over other pieces. \par
This design proved to fulfil more of the functional and non functional requirements set out at the beginning of the project. Originally an arm protruding from a base situated on one side of the chessboard was considered, but it was determined constructing such an arm with significant flexibility, range of motion, and strength to lift chess pieces would be a difficult task. Constructing the robot to mimic a gantry crane was also considered, but gantry cranes are situated on four uprights rather than two, so it would be relatively awkward for a user to move pieces within the robot's uprights. Finally, a modified version of the gantry crane was decided on, using two uprights with a bar connecting the two to support left-right motion, and two struts lying on the floor to support forwards-backwards motion. The other benefit of a half-gantry solution is the robot can retreat behind the chessboard after a turn, allowing the user access to the full board, and mimicking a human opponent, to anthropomorphise the robot. \par
\subsection{Forwards-Backwards Movement}
Forwards-backwards movement is achieved by inlaying plastic tracks in aluminium struts, and placing gears powered by motors directly on these tracks. The base holding the upright is then build around these gears, and the upright is placed within the base. Each base is driven by a single motor, to provide enough power that the gears do not catch or stutter while running along the tracks. Under normal strain one motor may have been enough to drive both bases, but because each base had to carry in excess of 900g, substantial power had to be provided to each base. The motors are driven in tandem so the bases move at the same time, to make sure the position of the gripper remains accurate. \par
Aluminium struts with inlayed tracks provides structure and stability that many other design options fail to. Placing the bases on wheels would make the robot more liable to turning if one wheel spun slightly faster than the other, causing the robot to skew in relation to the chessboard, and ruining the game. Additionally, wheels provide a less balanced base, whereas the current bases wrap around either side of the aluminium strut for additional support. Wheels or bases that could freely move would also be able to move beyond or far behind the chessboard, whereas with the aluminium struts the robot cannot move too far forwards or too far backwards. \par
\subsection{Left-Right Movement}
Left-right movement is achieved by a chain strung between two gears protruding past the bar connecting the two uprights. The gripper and pieces of lego that support up-down movement are suspended from this chain, so when the gears holding the chain up turn, and the chain moves, the gripper moves left and right across the chessboard. With the weight of the gripper and the lego supporting up-down movement, the chain does tend to sag, but sags directly into the crevice of the aluminium strut connecting the two uprights, so the chain does not meet with any friction from rubbing against the aluminium strut.\par
A chain suspended between two gears was preferable for the left-right movement as opposed to another motor-powered gear situated on plastic tracks because the motor powering the gears would have been situated to one side of the aluminium strut, which would have led the robot to be unbalanced. Additionally, gears situated on tracks inlayed in the aluminium strut (identical to how the forward-backward movement is controlled) presented problems because rear of the motor kept hitting one of the uprights when the squares at the edge of the board were accessed. Because the left-right movement only needs to support the gripper and the lego pieces supporting up-down movement, a chain was a feasible solution, as it wouldn't sag significantly. \par
\subsection{Up-Down Movement}
The gripper is suspended between two wide strips of lego, with each strip running up from the gripper along either side of the aluminium strut connecting the two uprights. The two strips of lego each run in between a gear on one side and smooth lego on the other when they reach the aluminium strut running between the two uprights. This is what holds the gripper at height, because the side of the lego strips that meet the gear is lined with tracks, so the teeth of the gear meet the teeth of the tracks, and hold it in place. \par
The decision to move just the gripper as opposed to the entire aluminium strut connecting the two uprights was primarily based on space and weight: moving the gripper alone was a significantly lighter feat than moving the aluminium strut as well as the gripper. Secondly, to move the aluminium strut, the left-right movement would have had to be redesigned, to move with the aluminium strut, as opposed to staying above the aluminium strut. \par
\subsection{Gripper}
The gripper is a very simple design, with inspiration drawn from last year's gantry crane design. The gripper is a claw design, but padded with foam so the gripper can grasp a variety of pieces without altering the orientation of any of them, so they can be set down on their bases. The gripper is opened and closed using a small motor positioned to one side of the gripper, spinning two gears which each control half of the claw. \par
This gripper was not the original design, which was a soft cushion on the end of the gripper, which was pressed into a piece, and then a vacuum pump caused the cushion to hold the piece in place until it was in the desired location, and then was released. However, this design did include the addition of a vacuum pump, which would have been additional weight, tubes running from the vacuum pump to the gripper, and was more steps to control. With the addition of the foam to the current claw-like design, the claw does not pick up the pieces so the base is no longer facing the chess board, which was why the claw-like design was originally rejected. \par
\subsection{Additional Components}
\subsubsection{Camera}
Checkmate uses a Logitech C720 HD webcam, with built in lighting correction and a 60\textdegree\: field of view. The camera is attached to a mount which is attached to Checkmate's base, and must remain in its given orientation throughout the duration of the game. 
\subsubsection{Camera Tower}
The camera tower is THIS tall, which is the minimum height required to allow the camera a view of the full chessboard. The camera tower is built from (is it lego still or ali strut now?), and the horizontal piece at the top of the tower is built from (this thing), and is (this long). The tower is connected to the (right or left) strut, with the centre of the tower lining up with the centre of the struct. 
\subsubsection{Chessboard}
Checkmate is able to play with a variety of chessboards, provided the chessboard is maximum 40cm\textsuperscript{2}, and minimum 20cm\textsuperscript{2}. The chessboard must be oriented straight in reference to the camera, and cannot be touched once the camera has been calibrated to the position of the board. 
\subsubsection{Chess Pieces}
Checkmate is able to play with a variety of chess pieces, provided the chess pieces are shorter than 10cm and taller than 2cm. The chess pieces must also be distinct colours, so Checkmate can distinguish between the piece colours, but do not need to be black and white. 
\subsubsection{Batteries}
Checkmate runs on 6 AA 1.5V batteries which must be inserted into the EV3 brick (located on the lefthand upright) in order for Checkmate to function. These batteries must be replaced relatively frequently (\texttildelow every 2 hours) so the motors can maintain full power, and Checkmate will reach the squares it needs to. 
\subsubsection{Keypad}
The keypad is a means of communication, allowing the user to respond to Checkmate's questions. The keypad is a numpad with stickers overlaid, and is connected to the Raspberry Pi via usb. 
\subsubsection{Speaker}
Checkmate uses the speaker to communicate with the user, to eliminate the need for a screen. The speaker is connected to the pi via (what). 
\section{Software}
\subsection{High Level Algorithm}

\begin{figure}[h!]
\centering
\begin{minipage}{.55\textwidth}
  \centering
  \includegraphics[width=.45\linewidth]{alg_flow_1}
  \captionof{figure}{High Level Algorithm}
  \label{fig:test1}
\end{minipage}%
\hspace{-3.75cm}
\begin{minipage}{.65\textwidth}
  \centering
  \includegraphics[width=.55\linewidth]{alg_flow_2}
  \captionof{figure}{Algorithm to Detect and Confirm a User's Move}
  \label{fig:test2}
\end{minipage}
\end{figure}

Add in something about using FEN notation here\newline
\subsection{Contents of Codebase}
\subsection{Key Algorithms}
\subsubsection{segmentation\_analysis(image)}
Segmentation\_analysis takes a raw image as an input (directly from the robot's camera), and edits the image, so the non-chessboard pieces of the image get cropped, and returns the values of the boundaries of the board.

\begin{algorithm}[H]
\caption{Pseudo-code for segmentation\_analysis(image}
\begin{algorithmic}[1]
\STATE \text{read raw image}
\STATE$\text{convert the image to grayscale}$
\STATE$\text{determine the height and width of the image}$ 
\STATE$\text{blur the image to reduce noise (apply a low pass filter to it)}$
\STATE \text{find the edge of the blurred image by taking the absolute value of the difference between the original grey}
\STATEx \text{image and a shifted grey image} 
\STATE$\text{sum the edge and smooth the image's histogram}$ 
\STATE$\text{find the highs and lows of the histogram}$
\STATE$\text{calculate the width of the board}$
\STATE$\text{locate the boundaries of the chessboard}$
\STATE$\text{check the ratios of the boundaries, to make sure the cropped image is square}$
\STATE $\text{return: horizontal and vertical boundaries}$
\end{algorithmic}
\end{algorithm}

 
\subsubsection{crop\_squares(image)} 
Crop\_squares takes the output of segmentation\_analysis, the image taken by the camera but cropped so only the chessboard is visible, and divides the image into 64 individual squares. 

\begin{algorithm}[H]
\caption{Pseudo-code for crop\_squares(image)}
\begin{algorithmic}[1]
\STATE $\text{read image, determine height and width of image}$
\STATE $corner_x,\:corner_y\:=\:0$ 
\STATE $square_{height},\:square_{width}\:=\:height\_of\_image / 8$ \COMMENT{image will always be square, so only need one value}
\STATE $i\:=\:0$
\WHILE {i < 8}
\STATE $letter = 'a',\:start = i*8,\:end = start + 8$
\FOR{j in range start to end}
\STATE $\text{crop the image to pixels corner\textsubscript{x}, corner\textsubscript{y}, square\textsubscript{height}, square\textsubscript{width}}$ 
\STATE $\text{resize board to 244x244 pixels, and antialias to eliminate noise}$ 
\STATE $\text{save into "cropped images" folder with tag of the letter and number of the square}$
\STATE $\text{adjust values for corner\textsubscript{x}, square\textsubscript{height}, and letter}$ 
\ENDFOR
\STATE $corner_x\:=\:0, square_{height}\:=\:0$
\STATE $\text{increment corner\textsubscript{y}, square\textsubscript{width}, and i}$ 
\ENDWHILE
\end{algorithmic}
\end{algorithm}
\subsubsection{detect\_empty(model, previousFEN, valid\_origins, probability\_rank, WorB)}
Detect\_empty determines a best guess for what square was left empty that previous was filled after a user's move. Detect\_empty is used if the robot makes an incorrect guess, in order to narrow down the possible correct guesses.

\begin{algorithm}[H]
\caption{Pseudo-code for detect\_empty(model, previousFEN, valid\_origins, probability\_rank, WorB)}
\begin{algorithmic}[1]
\STATE $\text{Read the FEN notation of the previous board state}$
\STATE $\text{Split the FEN notation into the eight subcomponents}$
\STATE $\text{Create a list of all valid origins (derived from the previousFEN input)}$
\STATE $\text{Crop the sides of each image to avoid other squares that may be present in the image}$
\STATE $\text{Generate a list of predicted empty squares based on the possible origin squares and analysis of the images}$
\STATE $\text{Find the square previously containing a piece with the highest probability of being empty after the user's move}$
\STATE $\text{Return: the empty square and the piece}$
\end{algorithmic}
\end{algorithm}

\subsubsection{detect\_move(model, piece, validmoves, WorB, kingside, queenside)}
Detect\_move is used to determine what move a user just made. Detect\_move is called every time a user presses the enter or yes key after it is the user's turn to move. 

\begin{algorithm}[H]
\caption{Pseudo-code for detect\_move(model, piece, validmoves, WorB, kingside, queenside)}
\begin{algorithmic}
\
\end{algorithmic}
\end{algorithm}


\subsubsection{userTurn(board, computerside, WorB)}
\subsubsection{gameplayloop(Board)}
\section{Integrating Hardware and Software}
\subsection{Components}
There are three primary components of the hardware and software, excluding the robot itself: The Raspberry Pi, which controls game logic, user interface, states, interprets vision, keypad inputs, and outputs sound, the server that runs the chess AI, and determines the next logical move, and the EV3 brick, which runs the motors. The key algorithms surrounding how the software controls the hardware surround moving the gripper to a specific square, picking up the piece at that square, and moving it to a second square. 
\subsection{Key Algorithms}
\subsubsection{squaretoCoordinates(square)}
\subsubsection{plan(move, board, enpassant)}
\subsubsection{movePiece(moveFrom, moveTo)}
\section{Testing}
\section{Reflection: Achievements and Difficulties}
Overall, the robot was successful in playing a full game of chess with a user, 
\section{Reflection: Performance During Demos and Trade Fair}
\section{Appendix}
to include:\\
image of the whole robot w labels for forwards backwards movement, left-right movement, up-down movement, gripper, camera, camera tower, ev3 brick, raspberry pi, speaker, keypad. \\
image of strut w base w labels: strut, cogs, base, motor\\
image of y-axis w holder for lego strips: chain, gears, strut, slots for lego strips, motors (for LR movement)\\
closeup of holder w lego strips: cogs, gears, motor, backend pressure\\
gripper: claw, foam, motor, gears\\
system image w keypad included \\

\section{References}
\noindent [1] \href{https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4734149/\#r63}{https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4734149/\#r63} \newline
[2] \href{https://www.tandfonline.com/doi/abs/10.3109/07420520903523719?casa_token=xuj5yeT4EWEAAAAA\%3ADS5C1NhfiI1XBogq05OfmNmXPNALfdGdCkl8oOSUKUsNgLJZQW5dzziJ_a5yXX3H1YCVc57m8jc\&}{Burkhart Kimberly \& Phelps James R. (2009) AMBER LENSES TO BLOCK BLUE LIGHT AND IMPROVE SLEEP: A RANDOMIZED TRIAL, Chronobiology International, 26:8, 1602-1612, DOI: 10.3109/07420520903523719} \newline
[3] \href{http://www.mentalhealthamerica.net/blog/how-blue-light-affects-mental-health}{http://www.mentalhealthamerica.net/blog/how-blue-light-affects-mental-health} \newline
[4]\href{https://uk.rs-online.com/web/p/tubing-struts/7613322/}{https://uk.rs-online.com/web/p/tubing-struts/7613322/}

\end{document}
